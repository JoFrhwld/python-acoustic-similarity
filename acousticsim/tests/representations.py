

from numpy import array,sum,sqrt
from numpy.linalg import norm
import unittest
import os
try:
    from corpustools.acousticsim.representations import (to_envelopes,
                                        to_mfcc,
                                        preproc)
except ImportError:
    import sys

    test_dir = os.path.dirname(os.path.abspath(__file__))
    corpustools_path = os.path.split(os.path.split(os.path.split(test_dir)[0])[0])[0]
    sys.path.append(corpustools_path)
    from corpustools.acousticsim.representations import (to_envelopes,
                                        to_mfcc,
                                        preproc)

from scipy.spatial.distance import euclidean

TEST_DIR = r'C:\Users\michael\Documents\Testing'

class EnvelopeTest(unittest.TestCase):
    def setUp(self):
        self.air_path = os.path.join(TEST_DIR,'s129_air1.wav')
        self.air_path16 = os.path.join(TEST_DIR,'s129_air1_16000.wav')
        self.beer_path = os.path.join(TEST_DIR,'s129_beer1.wav')
        self.beer_path16 = os.path.join(TEST_DIR,'s129_beer1_16000.wav')

        self.air_matlab_envs = array([[0.0233989942549329, 0.00661838476428734, 0.00788835662584308, 0.00412614464827849],
                                    [0.0102376729723930, 0.0228581500523383, 0.0197200976733908, 0.0283881404368893],
                                    [0.0110221325778860, 0.0249923113474565, 0.0371321010810126, 0.0570672046506576],
                                    [0.0454349843353780, 0.0440481936794642, 0.0225745891739113, 0.0591679989742019],
                                    [0.0748904117897575, 0.157753668368247, 0.0529391525500946, 0.0517724574537291],
                                    [0.0648961650971707, 0.202480002845135, 0.0568312639925642, 0.0451723122385235],
                                    [0.0753753557894396, 0.220154077036400, 0.0556417405115676, 0.0541879478192122],
                                    [0.0727769827793445, 0.186027816589807, 0.0304407513539354, 0.0266810009699731],
                                    [0.0711469169207734, 0.167198348134175, 0.0654035774242208, 0.148306235043189],
                                    [0.0738391484820650, 0.176138890294785, 0.124864722999352, 0.276748996964851],
                                    [0.0722375204256775, 0.167550578226932, 0.0275502651939039, 0.0266198653010239],
                                    [0.0693699698749767, 0.179746425179953, 0.0657799942926880, 0.0680400530500030],
                                    [0.0730745172468310, 0.173280304558821, 0.0466953248113483, 0.0371495683287792],
                                    [0.0652447105391107, 0.163426265920217, 0.0457777695035912, 0.0538286385103899],
                                    [0.0614410358144322, 0.150461493738134, 0.0467090591869444, 0.0571789063512524],
                                    [0.0636272992552695, 0.134252056256820, 0.0484638541923425, 0.0482586623907639],
                                    [0.0628711681805319, 0.127311947488385, 0.0403617615830296, 0.0477315965198929],
                                    [0.0584076607903536, 0.121361064523764, 0.0396955443222580, 0.0470276188031090],
                                    [0.0593798911823720, 0.119421790335179, 0.0492910730151913, 0.0419699531505017],
                                    [0.0627181362997473, 0.116899694975816, 0.0532438292794447, 0.0328368531472323],
                                    [0.0564852882446634, 0.108098863128237, 0.0431979012474368, 0.0347544851831661],
                                    [0.0517965755692510, 0.104707180643511, 0.0448256334102025, 0.0395840440492887],
                                    [0.0528685836800220, 0.103707589931710, 0.0361418598652412, 0.0445537345194519],
                                    [0.0538325610097047, 0.101901287674270, 0.0418000546014190, 0.0285861342909791],
                                    [0.0495294015354772, 0.104827269159876, 0.0478172580983188, 0.0387477205319452],
                                    [0.0441846834357002, 0.103102251718324, 0.0380509379374497, 0.0303459798925629],
                                    [0.0455553117593211, 0.103702205178911, 0.0495663136344243, 0.0253701145924114],
                                    [0.0463591092804981, 0.104323638424117, 0.0513915257487529, 0.0248480582815992],
                                    [0.0422541456951669, 0.109910018198044, 0.0602733939247239, 0.0330246789453796],
                                    [0.0375146979067396, 0.107286380723522, 0.0599428328621052, 0.0313976146726645],
                                    [0.0387060616709702, 0.107238267384264, 0.0712025389448478, 0.0334333116743793],
                                    [0.0409978474721384, 0.102082759159932, 0.0714511422749218, 0.0359353090808704],
                                    [0.0376423689372031, 0.0999601980607027, 0.0676561726841888, 0.0282094319002025],
                                    [0.0311887921544024, 0.0895738511104243, 0.0743100597185483, 0.0383421877923132],
                                    [0.0308136313000116, 0.0799985640153287, 0.0684229620426581, 0.0347125333558616],
                                    [0.0346761754383303, 0.0719782188251928, 0.0616292969318554, 0.0265730285423951],
                                    [0.0381566465413340, 0.0557054983738256, 0.0386062612110100, 0.0220145213071109],
                                    [0.0273484631274495, 0.0451183810280859, 0.0630257527943282, 0.0337534246921693],
                                    [0.0323859289438056, 0.0289414776215007, 0.0407638342125925, 0.0661665657092345],
                                    [0.0393043826969476, 0.0211581017162904, 0.0640035468242827, 0.0451849237517528],
                                    [0.0331741151269708, 0.00980141412438686, 0.0308399143145983, 0.0212189116599988],
                                    [0.0265099354641460, 0.0101440579761653, 0.0219852519621733, 0.0167097283522785],
                                    [0.0206423424169690, 0.0100660323514712, 0.0191668984365370, 0.0122639245554164],
                                    [0.0194878585826250, 0.00752622449494487, 0.0259412033666387, 0.0175435096556578],
                                    [0.00970478410730491, 0.00634382823539825, 0.0235631064418202, 0.0185781274242383],
                                    [0.00925552787654014, 0.00619685270897768, 0.0183634636244956, 0.0108100678623888],
                                    [0.00736928655999347, 0.00319785627505613, 0.0115372673430406, 0.0151319949165642],
                                    [0.00188325858830495, 0.00416785895321410, 0.00901021804514333, 0.0126165441809672],
                                    [0.00443844253265108, 0.00414256317566573, 0.00948944753998491, 0.00961561194206804],
                                    [0.00283261366638130, 0.00337976832663905, 0.00811563079469720, 0.0131314459467305],
                                    [0.00427079543713382, 0.00350756643292552, 0.00924312964805438, 0.0140100937946645],
                                    [0.00271556562007443, 0.00243217348071265, 0.00780818426281911, 0.0115798700381069],
                                    [0.00351003268937928, 0.00269561150668005, 0.00571647707980650, 0.0104018417688506],
                                    [0.00383786837307797, 0.00233459408806523, 0.00515699938586422, 0.00792833266110125],
                                    [0.00362413446095935, 0.00186883769153620, 0.00371900376993542, 0.00682100237911498],
                                    [0.00370801545915089, 0.00286375611824267, 0.00532528358186148, 0.00590356956296756],
                                    [0.00313951183292667, 0.00209830757277640, 0.00452381174611945, 0.00584229271804806],
                                    [0.00457639554218343, 0.00233029641643672, 0.00507157315712856, 0.00499130994141703],
                                    [0.00331744288249726, 0.00212188204177128, 0.00406349759270016, 0.00424003630326211],
                                    [0.00346482437511937, 0.00280143677835546, 0.00275818904408965, 0.00300837893093377],
                                    [0.00391448515261580, 0.00238346046391296, 0.00218174889173073, 0.00243837170427722],
                                    [0.00213649715085180, 0.00182995953357953, 0.00348926354453627, 0.00279652019531240],
                                    [0.00367802581564904, 0.00281857582400897, 0.00262122293349277, 0.00279042750224575],
                                    [0.00415136132451863, 0.00164885041861805, 0.00249744635144917, 0.00192147776936785],
                                    [0.00421303136037040, 0.00138893842998280, 0.00266062126961239, 0.00186495636611857]])
        self.beer_matlab_envs = array([[0.0204965520932122, 0.00432864038328518, -0.00132274079160796, 0.00176353860881669],
                                    [0.000347139132426852, 0.00333703786845405, 0.00925820802686654, 0.00935811216268189],
                                    [0.00287080035461139, 0.00102225535723236, 0.000821235625849339, 0.00284890735812749],
                                    [0.00376088682845466, 0.00559184921926976, 0.00894871436051159, 0.0160410471103323],
                                    [0.00471052114373564, 0.0134975802563661, 0.00998979362564536, 0.0212878545837324],
                                    [0.0299127729347846, 0.0116578635487601, 0.00359286256276362, 0.0212601324604305],
                                    [0.0394498898906338, 0.0488952555639987, 0.0136577048833310, 0.0886689795592123],
                                    [0.0478831593233462, 0.0682047988572429, 0.0260136515083428, 0.0578137559119941],
                                    [0.0596905990443961, 0.149599284539009, 0.0468053282037733, 0.120782570018092],
                                    [0.0553151843871592, 0.168021589476104, 0.0278243919301875, 0.0745239661966012],
                                    [0.0637056293354572, 0.179112715764148, 0.0262798107934756, 0.0553422422298855],
                                    [0.0692993090956819, 0.188702017022805, 0.0216249249431723, 0.0529942229743115],
                                    [0.0646365515386541, 0.185617048818380, 0.0297685686018308, 0.0681109830296876],
                                    [0.0688722295149897, 0.170574979250911, 0.0246887770000357, 0.0422931112477333],
                                    [0.0694067905220698, 0.164199470018859, 0.0285511468185870, 0.0620816032817158],
                                    [0.0617031940291114, 0.155652619807930, 0.0416191082483694, 0.0764800758207431],
                                    [0.0620444870501528, 0.146493247857513, 0.0265212360512130, 0.0385937513501432],
                                    [0.0623515595902386, 0.149159298733469, 0.0283119044204536, 0.0446596399487444],
                                    [0.0559880016181741, 0.161189582690240, 0.0327101184215735, 0.0447049467966394],
                                    [0.0543890831354904, 0.189065883683596, 0.0396455073436108, 0.0459813878815510],
                                    [0.0569551219168726, 0.216091349839359, 0.0349142758267561, 0.0356840493036666],
                                    [0.0522156299018717, 0.240372939797420, 0.0368707413120636, 0.0437868608666240],
                                    [0.0476221917822073, 0.233095149468335, 0.0429801019708040, 0.0415458743437113],
                                    [0.0486611081853056, 0.212651099217181, 0.0420737615114132, 0.0313181577121461],
                                    [0.0486412406543406, 0.172902873396890, 0.0514267055886499, 0.0501017842309317],
                                    [0.0445071723821708, 0.137524872059475, 0.0519407396096050, 0.0560796135668754],
                                    [0.0387262413390219, 0.137304033085159, 0.0667932473575349, 0.0438660376748686],
                                    [0.0388697147151273, 0.121501042874957, 0.0778854870520956, 0.0722620877711591],
                                    [0.0414547628295591, 0.119886582872322, 0.0621365314284254, 0.0511348353434229],
                                    [0.0391048591819330, 0.109125932219719, 0.0708507631122321, 0.0584824982199986],
                                    [0.0343953341395740, 0.107356421348789, 0.0647327815294326, 0.0673121970125063],
                                    [0.0309609436893987, 0.100759442010435, 0.0708771281675243, 0.0462903485074578],
                                    [0.0322734778667601, 0.0930853507346214, 0.0719140525136278, 0.0469452861306190],
                                    [0.0358153396907027, 0.0880617838890532, 0.0642460852577486, 0.0462793522965159],
                                    [0.0342323160149488, 0.0848685542946626, 0.0501023710129844, 0.0303262179740055],
                                    [0.0310528721118035, 0.0806395610713662, 0.0514149609585913, 0.0274931984931845],
                                    [0.0277301491282521, 0.0730630994814530, 0.0444504692419442, 0.0217836394345121],
                                    [0.0309475813152646, 0.0589001417670870, 0.0434203215494294, 0.0181013864082626],
                                    [0.0312938278791736, 0.0553864149585217, 0.0344188927828996, 0.0120188749202117],
                                    [0.0281009709713910, 0.0312249035757724, 0.0326738601518878, 0.0140996199736410],
                                    [0.0304525489652879, 0.0398652558417368, 0.0542884123530712, 0.0220402981347845],
                                    [0.0294211808928062, 0.0199138019128840, 0.0285591214519986, 0.0111004073095240],
                                    [0.0271534958787495, 0.00842995998921352, 0.0200189259146330, 0.00701482537982954],
                                    [0.0155435051221154, 0.00445405992275249, 0.0153266647603088, 0.00716136593591452],
                                    [0.0143866699217608, 0.00378618532054172, 0.0163517803883345, 0.00664107203419174],
                                    [0.00753072952429622, 0.00357534751239365, 0.0206382267070928, 0.00802429727769180],
                                    [0.00308328739791337, 0.00450386379851796, 0.0170375004435631, 0.00844108003102373],
                                    [0.00355723516813802, 0.00516937376022167, 0.0264137579198709, 0.0115128445797151],
                                    [0.00362463334562273, 0.00543796432953231, 0.0232703324233208, 0.0169451542576243],
                                    [0.00354393605455828, 0.00286914252586273, 0.0304597379124439, 0.0169565658640827],
                                    [0.00269502218538548, 0.00530876934465347, 0.0161151488158362, 0.0138157615357012],
                                    [0.00450185465260671, 0.00412491372776724, 0.0242031888151587, 0.0190841548696679],
                                    [0.00236372851293071, 0.00234230895432905, 0.0130088142925792, 0.0113786714595863],
                                    [0.00231933009628691, 0.00263102339965436, 0.0176286257610268, 0.0141411889543182],
                                    [0.00456595663407897, 0.00295245086823766, 0.0154354243320889, 0.00918657737007305],
                                    [0.00285559961968188, 0.00282755105231078, 0.0115265484592606, 0.00977288225465516],
                                    [0.00275596959122065, 0.00311528002468420, 0.0103873737428012, 0.00597925537210156],
                                    [0.00288550189437470, 0.00213593784738805, 0.00969989046762844, 0.00788986481130301],
                                    [0.00576539076186286, 0.00243421741833967, 0.00877579652431338, 0.00601414179279310],
                                    [0.00251558375110420, 0.00237927248640157, 0.00917951701442204, 0.00553058403750889],
                                    [0.00320647353471372, 0.00223827940988523, 0.00454680145796117, 0.00497795049549231],
                                    [0.00364689783968337, 0.00302133337628028, 0.00538756952215896, 0.00392879957014906],
                                    [0.00326172128500638, 0.00141644181493465, 0.00541028509928643, 0.00347862337075480],
                                    [0.00362003526090723, 0.00189506977796726, 0.00452325990241376, 0.00312700289190275],
                                    [0.00222633590502770, 0.000960717053209527, 0.00269791486563165, 0.00260636753891134],
                                    [0.00347131285601145, 0.00200581666408450, 0.00295151256512420, 0.00201866549006695],
                                    [0.00308836981349194, 0.00141038875781879, 0.00294895843443001, 0.00219526310009771],
                                    [0.00255578748436251, 0.00171489305425129, 0.00270771251083170, 0.00177698224279803],
                                    [0.00373728936885475, 0.00178724970521110, 0.00315827308479421, 0.00195638459209602],
                                    [0.00282498623820616, 0.00112124125488321, 0.00222309433185589, 0.00165112021461859],
                                    [0.00457756291438307, 0.00209956063996889, 0.00203563033564244, 0.00160934200343425],
                                    [0.00514296585574954, 0.00241866904237660, 0.00215954340821088, 0.00166590524748192]])

        self.num_bands = 4

        self.freq_lims = (80,7800)

        self.matlab_matchval = 0.2266

    def test_envelope_gen_air(self):
        envs = to_envelopes(self.air_path,self.freq_lims,self.num_bands)
        for i in range(self.num_bands):
            denom = sqrt(sum(envs[:,i]**2))
            envs[:,i] = envs[:,i]/denom
        print(envs[:,0])
        summed_dist = sum(sqrt((self.air_matlab_envs-envs) **2))
        print(summed_dist)
        self.assertTrue(summed_dist < 0.0001)



class MfccTest(unittest.TestCase):
    def setUp(self):
        self.path = os.path.join(TEST_DIR,'s129_air.wav')
        self.numCC = 12
        self.winLen = 512/16000
        self.timeStep = 256/16000
        self.matlabMfcc = array([[-12.6431900383024, -4.11124978708355, -8.39927505519070, -6.84749105388128, -6.85480312211548, -6.05639283075425, -6.59116209025136, -6.35550982517426, -3.41832566686831, -4.02182931281004, -2.65106705926123, -2.99819940508193, -2.30778514645189, -0.411632061457631, 0.625942602749560, 1.28149015576795, 1.29554681707301, 0.279062976842321, -0.265134940453222, -0.000248053411330993, 0.337039789375566, 3.76480993916839, 2.94008605165846, 2.12280963860397, -3.44612000860328, -4.11686023199763, -5.39123409196919, -1.41150958907003, -2.49255623276504, -4.95460784580001],
        [-4.05730021228181, 3.92852555480955, 5.97305669246826, 6.73321058743357, 7.44647449033269, 7.34587813963090, 7.85789022883109, 7.73397667062598, 4.56902248959431, -0.677525529611384, -5.09549389629633, -5.49150685084000, -8.63611601408430, -10.8406453346777, -12.1549505432557, -12.7888930397252, -13.3747168154787, -16.2591043297242, -15.6068850598847, -17.2451502427959, -16.1241611563671, -13.1899621044646, -11.6878292171303, -6.29034358052595, -12.4686978506948, -19.0762518534413, -22.8968673554816, -9.11343244281742, -1.90886513725121, 7.29138348727605],
[22.0306798265591, 22.0760813005152, 23.3516727681497, 25.1953774572909, 26.5397990303092, 24.2265155035167, 20.9841288446810, 17.6883544752606, 15.3772029902501, 15.5681982020768, 16.4495661008059, 15.5610610852308, 14.9612154376887, 14.1500647008950, 13.0349848269350, 9.08297847638858, 10.9361098591242, 12.8960761787767, 9.26804001362959, 9.23310014183982, 12.0186221239960, 9.54537218465689, 6.42060002651409, 17.5015862847899, 24.6696311931783, 19.8483915626917, 16.8612031100367, 12.6642576673037, 11.4325779133121, 21.0034330136751],
[-27.2535889687542, -35.2417066965514, -38.3226019423256, -34.7832732130129, -35.8250042773585, -35.0097116025137, -32.7444144700091, -32.1075358276230, -33.2418403954548, -28.4001168531173, -26.2873950313471, -24.5364232237130, -21.7520222976323, -20.1179259649045, -21.6203032799415, -18.5385523039657, -16.1161506870567, -16.1508485273020, -11.9159153515956, -13.7359348596800, -8.00734179306039, -2.11674943937257, 1.66097121482712, 4.24184370448343, 14.7360490803912, 12.6013322213738, 18.5548529475507, 8.00322599407388, 7.44136706113861, 8.36626451431917],
[-19.8791732884552, -30.2474328454546, -24.3900294502569, -28.0029907788255, -29.0459289296974, -26.1950382483364, -22.4561726287780, -18.8283346826904, -16.6106508134513, -25.9916790008025, -21.4478323602466, -18.5310723442777, -17.4009263471459, -17.7948609151450, -12.7048530638342, -14.4513647432306, -17.8353846613736, -13.5030481872956, -8.85633924487078, -9.83602417498314, -9.76431907793327, -10.5068628164658, -5.39868318768174, -2.80272277416321, 4.38954795334307, 3.00598203613582, 4.38119851311758, 6.70942973453174, 8.49117751576336, -1.81554840440983],
[1.32966283838449, -12.9985003008692, -8.04316645864802, -7.59042000662015, -10.2852812635049, -11.6164027935889, -16.6525486752631, -19.3219555214239, -19.8759839497387, -11.1350471374046, -12.9378920581037, -15.0980574039333, -12.6825365412094, -11.2463148398999, -13.6004132487233, -9.53103695462074, -4.85170424488302, -8.64247373383929, -7.81543651457696, -3.60894147622008, -0.232435182297726, 4.37377502009800, -1.30249791519882, 3.95961779700153, 10.4319863921451, 11.3510889560315, 14.8226036062117, 6.11493591857146, 12.0323851786871, 9.88998037757504],
[5.56498747234649, 6.17974065495386, 8.74639267446779, 12.9004637892936, 13.7825918141741, 14.1010792710966, 15.0185907686574, 16.2640607870346, 16.5743639929129, 18.7741954858544, 19.7244438072630, 24.1188660027892, 20.1872722973683, 23.0212315658774, 26.4012333215658, 21.1713302522291, 26.2641230570127, 22.5513619687369, 21.6062832133461, 19.1393604902652, 15.4441506826413, 9.55658070237957, 11.0089008917499, 4.09801436844764, -2.09733336896730, -1.20944738980806, -10.9200519932826, -11.3372902317157, -3.69976167168993, -3.26912993561542],
[-10.9153495926642, -21.1434766312004, -28.5389290236827, -27.3216744135402, -21.1735383679980, -17.5556436251888, -16.9450757387432, -16.5496467363008, -12.4367915728882, -19.7167250380373, -15.3162704799224, -18.0219477203364, -14.5366663897389, -14.5730817427552, -13.0486804896353, -2.65717858243729, -12.3512834494283, -5.73081365145198, -1.14357809015832, -0.283525537859710, 2.67873401219133, -3.93221723974886, -2.40589288811884, 0.634704507909726, -0.136704576997914, 0.546617744530202, 14.3816061204296, 13.2000877644548, -0.701061434018668, 6.22290592889300],
[7.63999462223566, 3.28509323328750, 10.3231983363384, 16.9981773095089, 11.6503361574799, 7.00891315382914, 14.0646046774172, 15.0115800596872, 11.1919279394408, 14.8282482754650, 7.43429808890402, 6.03801466946697, 5.15580572251729, 7.89323142352018, 4.65959802389136, 0.366780874993051, 10.1170843502941, 3.51623744966968, 3.11339352181777, -2.40736284129219, -6.51263978030173, -1.25642443788842, -7.11750182735345, -13.0832617130400, 2.98548951618758, 1.25527492543389, 12.2320840412696, 5.64438448548424, 4.43791536288697, -0.434165430041457],
[0.373716538623152, -6.62965757557485, -16.5092881621301, -21.0992730280629, -20.4609651648216, -12.7298062150581, -18.4196560006050, -10.5920322822895, -9.41600245822621, -11.9569334992839, -7.91868052324521, -10.1726402630870, -9.30256422374479, -15.1870511639641, -13.2688157069128, -19.7632580764917, -23.8643799558447, -22.3723092771984, -28.4977778627909, -28.6850505208693, -24.7917075615466, -27.7105208258874, -22.3597708013816, -22.5551348781499, -17.3131153594454, -12.8282169680205, -19.5892973500126, -16.6483062602605, 5.67960237302644, 4.67088909829900],
[-0.675238025032723, -7.11061387431964, -5.17508446842980, -10.5212212424821, -13.9805489146265, -13.0061255295009, -3.64179395901407, -7.91220410028818, -4.00798644588149, 0.879635385743963, -1.92576390229584, -0.945979929033468, -8.03356167639994, -8.19428854317041, -9.71472510299975, -3.36371354773745, -9.07884965960712, -8.51285161791480, -2.18590648310040, -4.94417508499088, -12.4482627686985, -11.0186159837084, -13.5392266043389, -4.01147231787475, -6.68541157507647, 1.15077006378276, 4.36083825903835, -0.0784899881400669, 2.39120487305976, 6.96171151639114],
[-6.13712683890103, -16.4927199016897, -20.0860315069963, -18.4941511304746, -14.5817833836632, -17.0004302747678, -23.0626149594185, -25.4933397070600, -25.6098187418918, -26.7680163388017, -25.6837265697137, -24.1669783698173, -15.2342441407717, -8.79764589747416, -10.0669535117613, -15.7704813653120, -6.08710629242132, -4.97639281300427, -8.27492379405294, -5.95022483646383, -4.16756615405278, -4.59388534133343, 2.09293761452189, 4.04413716017460, 4.15034451697720, 5.02532196424412, 7.37755061519176, 8.72889651641524, -2.19735786739655, -6.72737187527193]]).T


    def test(self):
        mfcc = to_mfcc(self.path,(0,8000),self.numCC,self.winLen,self.timeStep)
        print(mfcc[0,:])
        print(self.matlabMfcc[0,:])
        self.assertEqual(mfcc.shape,self.matlabMfcc.shape)
        self.assertTrue(norm(mfcc-self.matlabMfcc) < 1)

if __name__ == '__main__':
    unittest.main()
